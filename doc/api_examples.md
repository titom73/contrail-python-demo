# OpenContrail Configuration Python API

## 1 Architecture

### 1.1 Data Model

Configuration data model [vnc_cfg.xsd](https://github.com/Juniper/contrail-controller/blob/master/src/schema/vnc_cfg.xsd) is defined in XML Schema Definition (XSD) format.

Data model defines all configuration resources, their properties and relations.


### 1.2 REST API and Python API

The REST API is defined for CRUD (Create, Read, Update, Delete) operations to configuration resources.

Python API is the language wrapper of REST API. Python API is generated by [contrail-generateDS](https://github.com/Juniper/contrail-generateDS) from data model XSD.

Python API is installed from package python-contrail to Python library directory, for example, /usr/lib/python2.7/dist-packages/vnc_api on Ubuntu, /usr/lib/python2.7/site-packages/vnc_api on CentOS.


### 1.3 API Server

Configuration API server provides REST API support. Client connects to API server to operate configuration objects by REST API.

API server works in either authentication mode or non-authentication mode. In authentication mode, API server connects to authentication server to authenticate each request. Only requests from authenticated user are accepted. Currently, OpenStack Keystone service is supported as the authentication service. In non-authentication mode, any requests from any user is accepted.

The backend of API server is the Cassandra database for storing all configuration data.


### 1.4 Integration

OpenContrail networking can working alone. Client can connect to API server directly to manipulate configurations. OpenContrail can also be integrated with other orchestration/stack application. In case of the integration with OpenStack, OpenStack Neutron Plugin acts as the client of API server and connect frontend Neutron and backend OpenContrail together. Neutron database is not required. All networking data is stored at single place that is the OpenContrail database.


## 2 Connect to API server

Here is an example.
```
from vnc_api import vnc_api

vnc = vnc_api.VncApi(
        username = "admin",
        password = "password",
        tenant_name = "admin",
        api_server_host = "10.1.1.1",
        auth_host = "10.1.1.2")
```


## 3 Resource

There are multiple options to find out how resources are connected and configured.
* Read vnc_cfg.xsd to see all resources and their properties, links, etc.
* Read resource_common.py and resource_xsd.py to see how to use Python API configure resources.
* Run [show-schema](show-schema) that reads vnc_cfg.xsd and show resources, "show-schema list", "show-schema all", "show-schema <resource name>".


## 4 Examples

### IPAM
#### Create IPAM
Create IPAM default-domain:demo:ipam-default.
```
tenant = vnc.project_read(
        fq_name = 'default-domain:demo'.split(':')])
ipam = vnc_api.NetworkIpam(
        name = 'ipam-default',
        parent_obj = tenant)
vnc.network_ipam_create(ipam)
```

### Policy
#### Create policy
Create policy default-domain:demo:policy-default to allow all traffic.
```
rule = vnc_api.PolicyRuleType(
        direction = '<>',
        protocol = 'any',
        action_list = vnc_api.ActionListType(simple_action = 'pass'),
        src_addresses = [vnc_api.AddressType(virtual_network = 'any')],
        src_ports = [vnc_api.PortType(start_port = -1, end_port = -1)],
        dst_addresses = [vnc_api.AddressType(virtual_network = 'any')],
        dst_ports = [vnc_api.PortType(start_port = -1, end_port = -1)])
policy = vnc_api.NetworkPolicy(
        name = 'policy-default',
        parent_obj = tenant,
        network_policy_entries = vnc_api.PolicyEntriesType([rule]))
vnc.network_policy_create(policy)
```

### Virtual Network
#### Create virtual network
Create virtual network default-domain:demo:red with subnet 192.168.10.0/24.
```
vn = vnc_api.VirtualNetwork(
        name = 'red',
        parent_obj = tenant)
ipam = vnc.network_ipam_read(
        fq_name = 'default-domain:demo:ipam-default'.split(':'))
subnet = vnc_api.subnetType(
        ip_prefix = '192.168.10.0',
        ip_prefix_len = 24)
ipam_subnet = vnc_api.IpamSubnetType(
        subnet = subnet,
        default_gateway = '192.168.10.1')
vn.set_network_ipam(
        ref_obj = ipam,
        ref_data = vnc_api.VnSubnetsType([ipam_subnet]))
vnc.virtual_network_create(vn)
```

#### Attach policy
Attach policy policy-default to virtual network red.
```
policy = vnc.network_policy_read(
        fq_name = 'default-domain:demo:policy-default'.split(':'))
policy_type = vnc_api.VirtualNetworkPolicyType(
        sequence = vnc_api.SequenceType(major = 0, minor = 0))
vn = vnc.virtual_network_read(
        fq_name = 'default-domain:demo:red'.split(':'))
vn.add_network_policy(
        ref_obj = policy,
        ref_data = policy_type)
vnc.virtual_network_update(vn)
```

#### Set route target
Set route target for virtual network default-domain:admin:public.
```
vn = vnc.virtual_network_read(
        fq_name = 'default-domain:admin:public'.split(':'))
route_targets = vnc_api.RouteTargetList(['target:64512:10000'])
vn.set_route_target_list(route_targets)
vnc.virtual_network_update(vn)
```

### Floating IP
#### Create floating IP pool
Create floating IP pool in virtual network default-domain:admin:public. The pool is the address space of virtual network subnet(s).
```
vn = vnc.virtual_network_read(
        fq_name = 'default-domain:admin:public'.split(':'))
pool = vnc_api.FloatingIpPool(
        name = 'public-pool',
        parent_obj = vn)
vnc.floating_ip_pool_create(pool)

# Add reference to floating IP pool in the tenant who will need to
# allocate floating IP.
tenant = vnc.project_read(
        fa_name = 'default-domain:demo'.split(':'))
tenant.add_floating_ip_pool(pool)
vnc.project_update(tenant)
```

#### Allocate floating IP
Allocate a floating IP from the floating IP pool.
```
id = str(uuid.uuid4())
pool = vnc.floating_ip_pool_read(
        fq_name = 'default-domain:admin:public:public-pool'.split(':'))
fip = vnc_api.FloatingIp(
        name = id,
        parent_obj = pool)
fip.uuid = id
vnc.floating_ip_create(fip)
```

#### Assign floating IP
Assign a floating IP to a virtual machine interface.
```
vm = vnc.virtual_machine_read(id = <VM UUID>)

# Get the first interface.
if_id = vm.get_virtual_machine_interfaces()[0]['uuid']
if_obj = vnc.virtual_machine_interface_read(id = if_id)

tenant = vnc.project_read(
        fq_name = 'default-domain:demo'.split(':'))
fip.add_project(tenant)
fip.add_virtual_machine_interface(if_obj)
vnc.floating_ip_update(fip)
```

### Service Chain
#### Create service template
Create a service template.
```
template = vnc_api.ServiceTemplate(
        name = "firewall")
properties = vnc_api.ServiceTemplateType(
        service_mode = 'in-network',
        service_type = 'firewall',
        image_name = 'vsrx')                
properties.add_interface_type(
        vnc_api.ServiceTemplateInterfaceType(
            service_interface_type = 'left',
            shared_ip = False))
properties.add_interface_type(
        vnc_api.ServiceTemplateInterfaceType(
            service_interface_type = 'right',
            shared_ip = False))
template.set_service_template_properties(properties)
vnc.service_template_create(template)
```

#### Launch service instance
Launch a service instance.
```
tenant = vnc.project_read(
        fq_name = ['default-domain:demo'.split(':'))
instance = vnc_api.ServiceInstance(
        name = 'firewall',
        parent_obj = tenant)
properties = vnc_api.ServiceInstanceType(
        scale_out = vnc_api.ServiceScaleOutType())
instance.set_service_instance_properties(properties)
instance.set_service_template(template)
vnc.service_instance_create(instance)
```

#### Create service policy
Create a service chain policy. Attach the service policy to the left and right virtual networks. All traffic between left and right virtuan networks will go through the service chain as the order defined in service policy.
```
rule = vnc_api.PolicyRuleType(
    direction = '<>',
    protocol = 'any',
    action_list = vnc_api.ActionListType(
        apply_service = ['default-domain:demo:firewall']),
    src_addresses = [vnc_api.AddressType(
        virtual_network = 'default-domain:demo:left-vn')],
    src_ports = [vnc_api.PortType(start_port = -1, end_port = -1)],
    dst_addresses = [vnc_api.AddressType(
        virtual_network = 'default-domain:demo:right-vn')],
    dst_ports = [vnc_api.PortType(start_port = -1, end_port = -1)])
policy = vnc_api.NetworkPolicy(
    name = 'policy-firewall',
    parent_obj = tenant,
    network_policy_entries = vnc_api.PolicyEntriesType([rule]))
vnc.network_policy_create(policy)
```

### DNS
There are 4 options to configure DNS service for VM instance.
* No DNS: DNS server is the second address of subnet, set by DHCP to VM. No DNS service is provided.
* Default DNS: The default type when no DNS configuration is provided. DNS server is the second address of subnet, set by DHCP to VM. DNS request from VM -> DNS server (vRouter) -> vRouter agent -> DNS configuration on the compute node.
* Tenant DNS: DNS service is provided by tenant. DNS server is set to be tenant DNS server(s) by DHCP. DNS server could be some VM in virtual network or server in physical network, as long as it's reachable by VM.
* Virtual DNS: vDNS service runs on controller. DNS request from VM -> DNS server (vRouter) -> vRouter agent -> control node -> vDNS service. vDNS has an option of the next DNS server (forwarder). Total 16 servers can be chained together. There are 3 types of next DNS server.
  * Default, is provided by DNS on controller.
  * vDNS, is provided by another vDNS on controller.
  * Fabric, is provided by any DNS server that is reachable by control node.

#### Create virtual DNS
Create a virtual DNS. The next_virtual_DNS could be 'None', the name of another virtual DNS server or the IP address of DNS server reachable by fabric.
```
data = vnc_api.VirtualDnsType(
        domain_name = 'demo',
        dynamic_records_from_client = True,
        record_order = 'random',
        default_ttl_seconds = 86400,
        next_virtual_DNS = 'default-domain:another-virtual-dns')
obj = vnc_api.VirtualDns(
        name = 'vdns',
        virtual_DNS_data = data)
vnc.virtual_DNS_create(obj)
```

#### Configure DNS in IPAM
```
ipam = vnc_api.NetworkIpam(
        name = 'ipam-dns',
        parent_obj = tenant)
mgmt = vnc_api.IpamType()
mgmt.set_ipam_dns_method('virtual-dns-server')
mgmt.set_ipam_dns_server(
        vnc_api.IpamDnsAddressType(
            virtual_dns_server_name = 'vdns'))
ipam.set_network_ipam_mgmt(mgmt)
vnc.network_ipam_create(ipam)
```

### CPE
A compute node equitped with vrouter can be configured as a CPE device and deployed at customer's premise. Customer can connect a subnet directly to the compute node or a local router to the compute node.

#### Create physical router
Create a CPE type of physical router based on vrouter default-global-system-config:cpe-acme.
```
gsc = vnc.global_system_config_read(
        fq_name = ['default-global-system-config'])
prouter = vnc_api.PhysicalRouter(
        name = 'cpe-acme',
        parent_obj = gsc,
        physical_router_management_ip = '10.1.1.1',
        physical_router_dataplane_ip = '10.1.1.1',
        physical_router_vendor_name = 'Juniper',
        physical_router_product_name = 'CPE',
        physical_router_vnc_managed = True,
        physical_router_user_credentials = vnc_api.UserCredentials(
            username = 'root',
            password = 'password'))
vrouter = vnc.virtual_router_read(
        fq_name = 'default-global-system-config:cpe-acme'.split(':'))
prouter.add_virtual_router(vrouter)
vnc.physical_router_create(prouter)
```

#### Create physical interface
Create a physical interface. The name has to match the interface name on CPE/vrouter node.
```
pif = vnc_api.PhysicalInterface(
        name = 'p1p1',
        parent_obj = prouter)
vnc.physical_interface_create(pif)
```

#### Create logical interface
Create logical interface and attach subnet to it.
```
# Create a virtual network default-domain:demo:acme with
# subnet 192.168.100.0/24 where IP address will be allocated from.

# Create a VM interface on the virutual network.
id = str(uuid.uuid4())
vmi = vnc_api.VirtualMachineInterface(
        name = id,
        parent_obj = tenant)
vmi.uuid = id
vmi.add_virtual_network(vn)
vnc.virtual_machine_interface_create(vmi)

# Choose a subnet from user virtual network (192.168.100.0/24 from acme),
# create a user subnet and link it to the virtual machine interface.
id = str(uuid.uuid4())
subnet = vnc_api.Subnet(
        name = id,
        subnet_ip_prefix = vnc_api.SubnetType(
            ip_prefix = 192.168.100.0,
            ip_prefix_len = 24))
subnet.uuid = id
subnet.add_virtual_machine_interface(vmi)
vnc.subnet_create(subnet)

# Create a logical interface and link it to the virtual machine interface.
lif = vnc_api.LogicalInterface(
        name = 'p1p1.0',
        parent_obj = pif,
        logical_interface_vlan_tag = 0,
        logical_interface_type = 'l3')
lif.add_virtual_machine_interface(vmi)
vnc.logical_interface_create(lif)
```


### Appendix A. Data Model Graph

Data model graph can be generated from vnc_api/gen/vnc_api_schema.py. Some additional package are required. Here is an example.
```
# wget http://pydot.googlecode.com/files/pydot-1.0.28.tar.gz
# pip install pydot-1.0.28.tar.gz
# wget https://pypi.python.org/packages/source/p/pyparsing/pyparsing-2.0.3.tar.gz
# pip install pyparsing-2.0.3.tar.gz
# apt-get install graphviz
# python
>>> import pydot
>>> import vnc_api_schema
>>> graph = vnc_api_schema.generate_schema_graph()
>>> graph.write_png("schema.png")
```
